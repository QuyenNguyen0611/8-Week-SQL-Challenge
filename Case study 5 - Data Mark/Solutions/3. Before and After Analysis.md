# Case study 5 - Data Mark

### 1. What is the total sales for the 4 weeks before and after 2020-06-15? What is the growth or reduction rate in actual values and percentage of sales?
```sql
-- 20-06-15 is week_number 24
SELECT
  SUM(CASE WHEN week_number BETWEEN 20 AND 23 THEN sales ELSE 0 END) AS before_4,
  SUM(CASE WHEN week_number BETWEEN 24 AND 27 THEN sales ELSE 0 END) AS after_4,
  SUM(CASE WHEN week_number BETWEEN 24 AND 27 THEN sales ELSE 0 END)
    - SUM(CASE WHEN week_number BETWEEN 20 AND 23 THEN sales ELSE 0 END) AS change_abs,
  ROUND(
    100.0 *
    (
      SUM(CASE WHEN week_number BETWEEN 24 AND 27 THEN sales ELSE 0 END)
      - SUM(CASE WHEN week_number BETWEEN 20 AND 23 THEN sales ELSE 0 END)
    ) / NULLIF(SUM(CASE WHEN week_number BETWEEN 20 AND 23 THEN sales ELSE 0 END), 0)
  , 2) AS change_pct
FROM clean_weekly_sales
WHERE calendar_year = 2020;
```

| before_4    | after_4     | change_abs | change_pct |
|-------------|-------------|------------|------------|
| 2345878357  | 2318994169  | -26884188  | -1.15      |


### 2. What is the total sales for the 12 weeks before and after 2020-06-15? What is the growth or reduction rate in actual values and percentage of sales?
```sql
-- 20-06-15 is week_number 24
SELECT
  SUM(CASE WHEN week_number BETWEEN 12 AND 23 THEN sales ELSE 0 END) AS before_12,
  SUM(CASE WHEN week_number BETWEEN 24 AND 35 THEN sales ELSE 0 END) AS after_12,
  SUM(CASE WHEN week_number BETWEEN 24 AND 35 THEN sales ELSE 0 END)
    - SUM(CASE WHEN week_number BETWEEN 12 AND 23 THEN sales ELSE 0 END) AS change_abs,
  ROUND(
    100.0 *
    (
      SUM(CASE WHEN week_number BETWEEN 24 AND 35 THEN sales ELSE 0 END)
      - SUM(CASE WHEN week_number BETWEEN 12 AND 23 THEN sales ELSE 0 END)
    ) / NULLIF(SUM(CASE WHEN week_number BETWEEN 12 AND 23 THEN sales ELSE 0 END), 0)
  , 2) AS change_pct
FROM clean_weekly_sales
WHERE calendar_year = 2020;
```

| before_12   | after_12    | change_abs  | change_pct |
|-------------|-------------|-------------|------------|
| 7126273147  | 6973947753  | -152325394  | -2.14      |


### 3. How do the sale metrics for these 2 periods before and after compare with the previous years in 2018 and 2019?
```sql
-- 4 WEEK PERIODS
WITH week_periods as (
SELECT
	calendar_year,
	week_number, 
	SUM(sales) AS total_sales
FROM clean_weekly_sales
WHERE week_number BETWEEN 20 AND 27
GROUP BY calendar_year, week_number),

before_after_changes AS
(SELECT 
	calendar_year,
	SUM( CASE WHEN week_number BETWEEN 20 AND 23 THEN total_sales ELSE 0 END) AS before_sales,
    SUM( CASE WHEN week_number BETWEEN 24 AND 27 THEN total_sales ELSE 0 END) AS after_sales
FROM week_periods
GROUP BY calendar_year)

SELECT 
calendar_year,
after_sales - before_sales AS sales_variance, 
ROUND((after_sales - before_sales)*100/before_sales, 2) AS change_pct
FROM before_after_changes
ORDER BY calendar_year;
```

| calendar_year | sales_variance | change_pct |
|---------------|----------------|------------|
| 2018          | 4,102,105      | 0.19%      |
| 2019          | 2,336,594      | 0.10%      |
| 2020          | -26,884,188    | -1.15%     |

```sql
-- 12 WEEK PERIODS
WITH week_periods as (
SELECT
	calendar_year,
	week_number, 
	SUM(sales) AS total_sales
FROM clean_weekly_sales
WHERE week_number BETWEEN 12 AND 35
GROUP BY calendar_year, week_number),

before_after_changes AS
(SELECT 
	calendar_year,
	SUM( CASE WHEN week_number BETWEEN 12 AND 23 THEN total_sales ELSE 0 END) AS before_sales,
    SUM( CASE WHEN week_number BETWEEN 24 AND 35 THEN total_sales ELSE 0 END) AS after_sales
FROM week_periods
GROUP BY calendar_year)

SELECT 
calendar_year,
after_sales - before_sales AS sales_variance, 
ROUND((after_sales - before_sales)*100/before_sales, 2) AS change_pct
FROM before_after_changes
ORDER BY calendar_year;
```

| calendar_year | sales_variance | change_pct |
|---------------|----------------|------------|
| 2018          | 104,256,193    | 1.63       |
| 2019          | -20,740,294    | -0.30      |
| 2020          | -152,325,394   | -2.14      |


