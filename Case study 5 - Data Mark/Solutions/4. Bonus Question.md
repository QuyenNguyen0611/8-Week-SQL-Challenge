# Case study 5 - Data Mark

## 4. Bonus Question
Which areas of the business have the highest negative impact in sales metrics performance in 2020 for the 12 week before and after period?

- `region`
- `platform`
- `age_band`
- `demographic`

Do you have any further recommendations for Dannyâ€™s team at Data Mart or any interesting insights based off this analysis?

```sql

WITH sales_periods AS (
    SELECT
        week_date,
        calendar_year,
        region,
        platform,
        age_band,
        demographic,
        SUM(sales) AS total_sales
    FROM clean_weekly_sales
    WHERE calendar_year = 2020
    GROUP BY week_date, calendar_year, region, platform, age_band, demographic
),
before_after AS (
    SELECT
        s.region,
        s.platform,
        s.age_band,
        s.demographic,
        CASE
            WHEN s.week_date BETWEEN DATE_SUB('2020-06-15', INTERVAL 12 WEEK) AND DATE_SUB('2020-06-15', INTERVAL 1 DAY)
                THEN 'Before'
            WHEN s.week_date BETWEEN '2020-06-15' AND DATE_ADD('2020-06-15', INTERVAL 12 WEEK)
                THEN 'After'
        END AS period_flag,
        SUM(s.total_sales) AS period_sales
    FROM sales_periods s
    WHERE s.week_date BETWEEN DATE_SUB('2020-06-15', INTERVAL 12 WEEK) AND DATE_ADD('2020-06-15', INTERVAL 12 WEEK)
    GROUP BY s.region, s.platform, s.age_band, s.demographic, period_flag
),
comparison AS (
    SELECT
        region,
        platform,
        age_band,
        demographic,
        MAX(CASE WHEN period_flag = 'Before' THEN period_sales END) AS sales_before,
        MAX(CASE WHEN period_flag = 'After' THEN period_sales END) AS sales_after
    FROM before_after
    GROUP BY region, platform, age_band, demographic
)
SELECT
    region,
    platform,
    age_band,
    demographic,
    sales_before,
    sales_after,
    (sales_after - sales_before) AS sales_change,
    ROUND(((sales_after - sales_before) / NULLIF(sales_before,0)) * 100, 2) AS pct_change
FROM comparison
ORDER BY pct_change ASC;  -- most negative first
```

The table below highlights the 10 customer segments and regional combinations that experienced the largest percentage declines in sales.

| region         | platform | age_band     | demographic | sales_before | sales_after | sales_change | pct_change |
|----------------|----------|--------------|-------------|--------------|-------------|--------------|------------|
| SOUTH AMERICA  | Retail   | Retirees     | Couples     | 1,815,957    | 1,516,784   | -299,173     | -16.47%    |
| SOUTH AMERICA  | Retail   | Young Adults | Families    | 553,679      | 493,502     | -60,177      | -10.87%    |
| SOUTH AMERICA  | Retail   | Retirees     | Families    | 1,004,147    | 926,242     | -77,905      | -7.76%     |
| SOUTH AMERICA  | Retail   | Middle Age   | Couples     | 844,339      | 800,230     | -44,109      | -5.22%     |
| ASIA           | Retail   | unknown      | unknown     | 6,495,620,53 | 6,171,208,87| -324,411,66  | -4.99%     |
| SOUTH AMERICA  | Retail   | Middle Age   | Families    | 879,502      | 836,235     | -43,267      | -4.92%     |
| EUROPE         | Shopify  | Retirees     | Families    | 355,854      | 339,294     | -16,560      | -4.65%     |
| OCEANIA        | Retail   | unknown      | unknown     | 8,527,916,18 | 8,137,339,26| -390,542,42  | -4.58%     |
| SOUTH AMERICA  | Retail   | Young Adults | Couples     | 1,735,608    | 1,659,359   | -76,249      | -4.39%     |


