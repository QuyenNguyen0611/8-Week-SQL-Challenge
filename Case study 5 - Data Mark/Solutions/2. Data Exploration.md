# Case study 5 - Data Mark

## 2. Data exploration

### Question 1. What day of the week is used for each week_date value?

```sql
SELECT 
  DISTINCT(DAYNAME((week_date))) AS week_day
FROM clean_weekly_sales;
```

| week_day |
|----------|
| Monday   |

### Question 2. What range of week numbers are missing from the dataset?
```sql
WITH RECURSIVE week_number_cte AS (
  SELECT 1 AS week_number
  UNION ALL
  SELECT week_number + 1 FROM week_number_cte WHERE week_number < 52
)
SELECT w.week_number
FROM week_number_cte AS w
LEFT JOIN (
  SELECT DISTINCT week_number
  FROM clean_weekly_sales
  WHERE calendar_year = 2020
) s
  ON s.week_number = w.week_number
WHERE s.week_number IS NULL
ORDER BY w.week_number;
```

The query returned 28 rows; 5 sample rows are shown below.

| week_number |
|-------------|
| 1           |
| 2           |
| 3           |
| 4           |
| 5           |

### Question 3. How many total transactions were there for each year in the dataset?
```sql
SELECT
  calendar_year,
  SUM(transactions) AS total_transactions
FROM clean_weekly_sales
GROUP BY calendar_year
ORDER BY calendar_year;
```

| calendar_year| total_transactions|
|--------------|-------------------|
| 2018         |346406460          |
| 2019         |365639285          |
| 2020         |375813651          |

### Question 4. What is the total sales for each region for each month?
```sql
SELECT
  calendar_year,
  week_month AS month_number,
  region,
  SUM(sales) AS total_sales
FROM clean_weekly_sales
GROUP BY calendar_year, week_month, region
ORDER BY calendar_year, week_month, region;
```

| calendar_year | month_number | region | total_sales |
|---------------|--------------|--------|-------------|
| 2018          | 3            | AFRICA | 130542213   |
| 2018          | 3            | ASIA   | 119180883   |
|...            |...           | ...    | ....        |


### Question 5. What is the total count of transactions for each platform?
```sql
SELECT
	platform,
	SUM(transactions) as transaction_count
FROM clean_weekly_sales
GROUP BY platform;
```

| platform | transaction_count |
|----------|-------------------|
| Retail   | 1081934227        |
| Shopify  | 5925169           |

### Question 6. What is the percentage of sales for Retail vs Shopify for each month?
```sql
SELECT
	calendar_year,
	week_month,
	ROUND(100.0 * SUM(CASE WHEN platform='Retail'  THEN sales ELSE 0 END)/SUM(sales), 2) AS retail_pct,
	ROUND(100.0 * SUM(CASE WHEN platform='Shopify' THEN sales ELSE 0 END)/SUM(sales), 2) AS shopify_pct
FROM clean_weekly_sales
GROUP BY calendar_year, week_month
ORDER BY calendar_year, week_month;
```

| calendar_year | week_month | retail_pct | shopify_pct |
|---------------|------------|------------|-------------|
| 2018          | 3          | 97.92      | 2.08        |
| 2018          | 4          | 97.93      | 2.07        |
| 2018          | 5          | 97.73      | 2.27        |
| 2018          | 6          | 97.76      | 2.24        |
| 2018          | 7          | 97.75      | 2.25        |
| 2018          | 8          | 97.71      | 2.29        |
| 2018          | 9          | 97.68      | 2.32        |


### Question 7. What is the percentage of sales by demographic for each year in the dataset?
```sql
SELECT 
	calendar_year, 
	ROUND(100*SUM(CASE WHEN demographic = 'Families' THEN sales ELSE 0 END)/SUM(sales), 2) AS families_pct, 
	ROUND(100*SUM(CASE WHEN demographic = 'Couples' THEN sales ELSE 0 END)/SUM(sales), 2) AS couples_pct, 
	ROUND(100*SUM(CASE WHEN demographic = 'Unknown' THEN sales ELSE 0 END)/SUM(sales), 2) AS unknown_pct
FROM clean_weekly_sales
GROUP BY calendar_year
ORDER BY calendar_year;
```

| calendar_year | families_pct | couples_pct | unknown_pct |
|---------------|--------------|-------------|-------------|
| 2018          | 31.99        | 26.38       | 41.63       |
| 2019          | 32.47        | 27.28       | 40.25       |
| 2020          | 32.73        | 28.72       | 38.55       |

### Question 8. Which age_band and demographic values contribute the most to Retail sales? 
```sql
SELECT
	age_band, 
	demographic, 
	SUM(sales) as total_sales, 
	ROUND(100* SUM(sales)/ 
		(SELECT SUM(sales) FROM clean_weekly_sales), 2) AS pct
FROM clean_weekly_sales
GROUP BY age_band, demographic
ORDER BY total_sales DESC;
```

| age_band     | demographic | total_sales  | pct   |
|--------------|-------------|--------------|--------|
| unknown      | unknown     | 16338612234  | 40.10 |
| Retirees     | Families    | 6750457132   | 16.57 |
| Retirees     | Couples     | 6531115070   | 16.03 |
| Middle Age   | Families    | 4556141618   | 11.18 |
| Young Adults | Couples     | 2679593130   | 6.58  |
| Middle Age   | Couples     | 1990499351   | 4.89  |
| Young Adults | Families    | 1897215692   | 4.66  |


### Question 9. Can we use the avg_transaction column to find the average transaction size for each year for Retail vs Shopify? If not - how would you calculate it instead?
```sql
SELECT
	calendar_year,
	platform,
	ROUND(SUM(sales) / NULLIF(SUM(transactions), 0), 2) AS avg_transaction_size
FROM clean_weekly_sales
WHERE platform IN ('Retail','Shopify')
GROUP BY calendar_year, platform
ORDER BY calendar_year, platform;
```

| calendar_year | platform | avg_transaction_size |
|---------------|----------|-----------------------|
| 2018          | Retail   | 36.56                 |
| 2018          | Shopify  | 192.48                |
| 2019          | Retail   | 36.83                 |
| 2019          | Shopify  | 183.36                |
| 2020          | Retail   | 36.56                 |
| 2020          | Shopify  | 179.03                |



