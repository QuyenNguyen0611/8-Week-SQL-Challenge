# Case study 5 - Data Mark

## 1. Data Cleansing
In a single query, perform the following operations and generate a new table in the `data_mart` schema named `clean_weekly_sales`:

- Convert the `week_date` to a DATE format
- Add a `week_number` as the second column for each `week_date` value, for example any value from the 1st of January to 7th of January will be 1, 8th to 14th will be 2 etc
- Add a `month_number` with the calendar month for each `week_date` value as the 3rd column
- Add a `calendar_year` column as the 4th column containing either 2018, 2019 or 2020 values
- Add a new column called `age_band` after the original segment column using the following mapping on the number inside the segment value

```sql
DROP TABLE IF EXISTS clean_weekly_sales;

CREATE TABLE clean_weekly_sales AS
SELECT
-- Convert the `week_date` column to DATE format and extract the week number, month, and year
STR_TO_DATE(week_date, '%d/%m/%y') AS week_date,
WEEK(STR_TO_DATE(week_date, '%d/%m/%y')) AS week_number,
MONTH(STR_TO_DATE(week_date, '%d/%m/%y')) AS week_month,
YEAR(STR_TO_DATE(week_date, '%d/%m/%y'))  AS calendar_year,
region,
platform,
segment,
-- Extract the first and last characters from `segment` using LEFT() and RIGHT(),
-- and map them to `age_band` and `demographic`
(CASE 
	WHEN RIGHT(segment, 1) = '1' THEN 'Young Adults' 
    WHEN RIGHT(segment, 1) = '2' THEN 'Middle Age'
    WHEN RIGHT(segment, 1) IN ('3', '4') THEN 'Retirees' 
    ELSE 'unknown' END) AS age_band,
(CASE 
	WHEN LEFT(segment, 1) = 'C' THEN 'Couples' 
    WHEN LEFT(segment, 1) = 'F' THEN 'Families'
    ELSE 'unknown' END) AS demographic,
transactions,
sales,
-- Calculate `avg_transaction`
ROUND(sales / NULLIF(transactions, 0), 2) AS avg_transaction
FROM weekly_sales;

SELECT *
FROM clean_weekly_sales
;
```

| week_date  | week_number | week_month | calendar_year | region  | platform | segment | age_band    | demographic | transactions |   sales   | avg_transaction |
|------------|-------------|------------|----------------|---------|----------|---------|-------------|-------------|--------------|-----------|-----------------|
| 2020-08-31 | 35          | 8          | 2020           | ASIA    | Retail   | C3      | Retirees    | Couples     | 120631       | 3656163   | 30.31           |
| 2020-08-31 | 35          | 8          | 2020           | ASIA    | Retail   | F1      | Young Adults| Families    | 31574        | 996575    | 31.56           |
| 2020-08-31 | 35          | 8          | 2020           | USA     | Retail   | null    | unknown     | unknown     | 529151       | 1650916   | 31.20           |
| 2020-08-31 | 35          | 8          | 2020           | EUROPE  | Retail   | C1      | Young Adults| Couples     | 4517         | 141942    | 31.42           |
