# Case study 6 - Clique Bait

## 3. Product Funnel Analysis

This query analyzes the **product funnel** to show:

- Total product views (`event_type = 1`)
- Total adds to cart (`event_type = 2`)
- Abandoned carts (added to cart but no purchase in that visit)
- Successful purchases (`event_type = 3`)

### Query logic
1. **CTE1**: Summarizes each product per visit, counting page views and cart adds.  
2. **purchase_event**: Captures all visits where a purchase occurred.  
3. **combined_table**: Joins CTE1 with purchase_event to flag whether a purchase happened in each visit.  
4. **product_info**: Aggregates the results by product, calculating views, adds to cart, abandoned carts, and purchases.

```sql
WITH CTE1 AS(
SELECT 
    e.visit_id,
    ph.product_id,
    ph.page_name AS product_name,
    ph.product_category,
    SUM(CASE WHEN e.event_type = 1 THEN 1 ELSE 0 END) AS page_view, -- 1 for Page View
    SUM(CASE WHEN e.event_type = 2 THEN 1 ELSE 0 END) AS cart_add -- 2 for Add Cart
FROM events AS e
JOIN page_hierarchy AS ph
ON e.page_id = ph.page_id
WHERE ph.product_id IS NOT NULL
GROUP BY e.visit_id, ph.product_id, ph.page_name, ph.product_category), 

purchase_event AS(
SELECT 
DISTINCT visit_id
FROM events
WHERE event_type = 3),

combined_table AS(
SELECT 
c.visit_id, 
product_id, 
product_name, 
product_category, 
page_view, 
cart_add,
CASE WHEN p.visit_id IS NOT NULL THEN 1 ELSE 0 END AS purchased
FROM CTE1 c
LEFT JOIN purchase_event p
ON c.visit_id = p.visit_id),

product_info AS(
SELECT 
product_name, 
product_category, 
SUM(page_view) AS views,
SUM(cart_add) AS cart_added,
SUM(CASE WHEN cart_add = 1 AND purchased = 0 THEN 1 ELSE 0 END) AS abandoned,
SUM(CASE WHEN cart_add = 1 AND purchased = 1 THEN 1 ELSE 0 END) AS purchased
FROM combined_table
GROUP BY product_name, product_category)

SELECT * 
FROM product_info;
```

#### `product_info` Output

| product_name   | product_category | views | cart_added | abandoned | purchased |
|----------------|-----------------|------:|-----------:|----------:|----------:|
| Russian Caviar | Luxury          |  1563 |        946 |       249 |       697 |
| Lobster        | Shellfish       |  1547 |        968 |       214 |       754 |
| Crab           | Shellfish       |  1564 |        949 |       230 |       719 |
| Oyster         | Shellfish       |  1568 |        943 |       217 |       726 |
| Kingfish       | Fish            |  1559 |        920 |       213 |       707 |
| Tuna           | Fish            |  1515 |        931 |       234 |       697 |
| Black Truffle  | Luxury          |  1469 |        924 |       217 |       707 |
| Abalone        | Shellfish       |  1525 |        932 |       233 |       699 |
| Salmon         | Fish            |  1559 |        938 |       227 |       711 |


Additionally, create another table which further aggregates the data for the above points but this time for each product category instead of individual products.

```sql
WITH CTE1 AS(
SELECT 
    e.visit_id,
    ph.product_id,
    ph.page_name AS product_name,
    ph.product_category,
    SUM(CASE WHEN e.event_type = 1 THEN 1 ELSE 0 END) AS page_view, -- 1 for Page View
    SUM(CASE WHEN e.event_type = 2 THEN 1 ELSE 0 END) AS cart_add -- 2 for Add Cart
FROM events AS e
JOIN page_hierarchy AS ph
ON e.page_id = ph.page_id
WHERE ph.product_id IS NOT NULL
GROUP BY e.visit_id, ph.product_id, ph.page_name, ph.product_category), 

purchase_event AS(
SELECT 
DISTINCT visit_id
FROM events
WHERE event_type = 3),

combined_table AS(
SELECT 
c.visit_id, 
product_id, 
product_name, 
product_category, 
page_view, 
cart_add,
CASE WHEN p.visit_id IS NOT NULL THEN 1 ELSE 0 END AS purchased
FROM CTE1 c
LEFT JOIN purchase_event p
ON c.visit_id = p.visit_id),

product_category_info AS (
SELECT 
product_category, 
SUM(page_view) AS views,
SUM(cart_add) AS cart_added,
SUM(CASE WHEN cart_add = 1 AND purchased = 0 THEN 1 ELSE 0 END) AS abandoned,
SUM(CASE WHEN cart_add = 1 AND purchased = 1 THEN 1 ELSE 0 END) AS purchased
FROM combined_table
GROUP BY product_category)

SELECT *
FROM product_category_info;
```

#### `product_category_info` Output

| product_category | views | cart_added | abandoned | purchased |
|------------------|------:|-----------:|----------:|----------:|
| Luxury           |  3032 |       1870 |       466 |      1404 |
| Shellfish        |  6204 |       3792 |       894 |      2898 |
| Fish             |  4633 |       2789 |       674 |      2115 |


**Use the 2 new output tables - answer the following questions:**

- Which product had the most views, cart adds and purchases?

Product_name: Oyster had the most views (1568); Lobster had the most cart adds (968) and purchases (754).
Product_category: Shellfish had the most views, cart adds, and purchases

| product_category | views | cart_added | purchased |
|------------------|------:|-----------:|----------:|
| Shellfish        |  6204 |       3792 |      2898 |

- Which product was most likely to be abandoned?

```sql
SELECT 
product_name,
ROUND(abandoned*100/cart_added, 1) AS pct_abandon 
FROM product_info
ORDER BY pct_abandon DESC
LIMIT 1;
```

| product_name | pct_abandon |
|--------------|-------------|
| Russian Caviar | 26.3      |

**_Russian Caviar was most likely to be abandoned, around 26.3% (249)_**

```sql
SELECT 
product_category,
abandoned/cart_added AS pct_abandon
FROM product_category_info;
```

| product_category | pct_abandon |
|------------------|------------:|
| Luxury           |        24.9 |
| Shellfish        |        23.6 |
| Fish             |        24.2 |

_**Luxury is slightly higher at 24.9%**_

- Which product had the highest view to purchase percentage?

```sql
SELECT 
product_name,
ROUND(purchased*100/views, 1) AS pct_purchase
FROM product_info
ORDER BY pct_purchase DESC
LIMIT 1;
```

| product_name | pct_purchase |
|--------------|--------------|
| Lobster      | 48.7         |

- What is the average conversion rate from view to cart add?
- What is the average conversion rate from cart add to purchase?

```sql
SELECT 
ROUND(AVG((cart_added*100/views)),2) AS conversion_rate_views_to_cart_add,
ROUND(AVG((purchased*100/cart_added)),2) AS conversion_rate_cart_add_to_purchase
FROM product_info;
```

| conversion_rate_views_to_cart_add | conversion_rate_cart_add_to_purchase |
|-----------------------------------|--------------------------------------|
| 60.95                             | 75.93                                |






