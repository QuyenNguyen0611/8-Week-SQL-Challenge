# Case study 6: Clique Bait

## 2. Digital Analysis

### Q1. How many users are there?
```sql
SELECT COUNT(DISTINCT user_id) as total_users
FROM users
;
```

| total_users |
|-------------|
|500          |

### Q2. How many cookies does each user have on average?
```sql
WITH cookie_count AS (
SELECT
user_id, 
COUNT(cookie_id) as count
FROM users
GROUP BY user_id
)

SELECT 
ROUND(AVG(count),0) as avg_cookie_each_user
FROM cookie_count;
```

| avg_cookie_each_user |
|----------------------|
|4                     |

### Q3. What is the unique number of visits by all users per month?
```sql
SELECT 
month(event_time) AS month,
count(distinct visit_id) AS total_visits
FROM events 
GROUP BY month(event_time)
ORDER BY month(event_time);
```
| month | total_visits |
|-------|--------------|
| 1     |876           |
| 2     |1488          |
| 3     |916           |
| 4     |248           |
| 5     |36            |

### Q4. What is the number of events for each event type?
```sql
SELECT 
event_type,
COUNT(event_type) as number_of_events
FROM events 
group by event_type;
```

| event_type | number_of_events |
|------------|------------------|
| 1          | 20928            |
| 2          | 8451             |
| 3          | 1777             |
| 4          | 876              |
| 5          | 702              |


### Q5. What is the percentage of visits which have a purchase event?
```sql
SELECT 
100 * COUNT(DISTINCT e.visit_id)/
(SELECT COUNT(DISTINCT visit_id) FROM events) AS percentage_purchase
FROM events AS e
JOIN event_identifier AS ei
ON e.event_type = ei.event_type
WHERE ei.event_name = 'Purchase';
```
| percentage_purchase | 
|---------------------|
| 49.8597             |

### Q6. What is the percentage of visits which view the checkout page but do not have a purchase event?
```sql
WITH checkout_purchase AS (
	SELECT 
	visit_id,
	MAX(CASE WHEN event_type = 1 AND page_id = 12 THEN 1 ELSE 0 END) AS checkout,
    MAX(CASE WHEN event_type = 3 THEN 1 ELSE 0 END) AS purchase
  FROM events
  GROUP BY visit_id
)
SELECT 
  CASE 
    WHEN SUM(checkout) = 0 THEN NULL
    ELSE ROUND(100 * (1 - SUM(purchase) / SUM(checkout)), 2)
  END AS percentage_checkout_view_with_no_purchase
FROM checkout_purchase;
```

|percentage_checkout_view_with_no_purchase|
|-----------------------------------------|
|15.50                                    |

### Q7. What are the top 3 pages by number of views?
```sql
SELECT 
	p.page_name,
	COUNT(*) as number_of_views
FROM events e
JOIN page_hierarchy p
ON e.page_id = p.page_id
GROUP BY p.page_name
ORDER BY number_of_views DESC
LIMIT 3;
```

| page_name   | number_of_views |
|-------------|----------------:|
| All Products|            4752 |
| Lobster     |            2515 |
| Crab        |            2513 |


### Q8. What is the number of views and cart adds for each product category?
```sql
-- event_type = 2 (Add to Cart) & event_type = 1 (Page View)
SELECT
	p.product_category,
	SUM(CASE WHEN e.event_type = 1 THEN 1 ELSE 0 END) AS page_views, -- event_type = 2 (Add to Cart)
	SUM(CASE WHEN e.event_type = 2 THEN 1 ELSE 0 END) AS cart_adds -- event_type = 1 (Page View)
FROM events e
JOIN page_hierarchy p
ON e.page_id = p.page_id
WHERE p.product_category IS NOT NULL
GROUP BY p.product_category
ORDER BY page_views DESC;
```

| product_category | page_views | cart_adds |
|------------------|-----------:|----------:|
| Shellfish        |       6204 |      3792 |
| Fish             |       4633 |      2789 |
| Luxury           |       3032 |      1870 |


### Q9. What are the top 3 products by purchases?
- `cart_add`: selects all products that were added to the cart.
- `purchase_visits`: identifies the visits where event_type = 3 (meaning a purchase occurred).
- `purchased_products`: keeps only the products that were added to the cart within those purchase visits.
- Finally, it counts the number of times each product was purchased and returns the Top 3.
  
```sql
WITH cart_add AS (
  SELECT 
    e.visit_id,
    ph.product_id,
    ph.page_name AS product_name,
    ph.product_category
  FROM events AS e
  JOIN page_hierarchy AS ph
    ON e.page_id = ph.page_id
  WHERE ph.product_id IS NOT NULL
    AND e.event_type = 2   -- Add to Cart
),

purchase_visits AS (
  SELECT DISTINCT e.visit_id
  FROM events e
  WHERE e.event_type = 3   -- Purchase
),

purchased_products AS (
  SELECT 
    c.product_id,
    c.product_name,
    c.product_category,
    COUNT(*) AS purchase_count
  FROM cart_add c
  JOIN purchase_visits p
    ON c.visit_id = p.visit_id
  GROUP BY c.product_id, c.product_name, c.product_category
)

SELECT 
  product_name,
  purchase_count
FROM purchased_products
ORDER BY purchase_count DESC
LIMIT 3;
```
| product_name | purchase_count |
|--------------|----------------|
| Lobster 	   | 754			|
| Oyster	   | 726            |
| Crab         | 719 			|



